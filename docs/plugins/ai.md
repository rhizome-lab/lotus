# AI Plugin

The AI Plugin integrates Large Language Models (LLMs) and image generation capabilities into the Lotus engine. It allows for dynamic content generation, NPC interactions, and AI-assisted coding.

## Configuration

The plugin uses the Vercel AI SDK and supports various providers. Configuration is handled via environment variables:

- `AI_PROVIDER`: The AI provider to use (default: `openai`).
- `AI_MODEL`: The specific model to use (default: `gpt-4o`).

### Supported Providers

The plugin supports a wide range of providers including:

- `openai`
- `anthropic`
- `google` (Google Generative AI)
- `google-vertex`
- `mistral`
- `cohere`
- `huggingface`
- And many others supported by the Vercel AI SDK.

## Commands

### `talk <npc> <message>`

Allows the player to talk to an NPC in the current room. The NPC's response is generated by the AI based on the NPC's name, description, and adjectives.

**Usage:**

```
talk guard Hello, can I pass?
```

### `gen <template> [instruction]`

Generates game content based on a registered template.

**Available Templates:**

- `item`: Generates an item in the current room.
- `room`: Generates a new room and transports the player there.

**Usage:**

```
gen item a rusty sword with magical runes
gen room a dark dungeon cell
```

### `image <description>` or `image <target> <prompt>`

Generates an image using DALL-E 3.

**Usage:**

- Generate a standalone image:
  ```
  image a futuristic city skyline
  ```
- Generate an image for an item or room (updates the entity's `image` property):
  ```
  image sword a glowing blue sword
  image here a spooky forest clearing
  ```

## RPC Methods

### `ai_completion`

Provides code completion suggestions for the LotusScript editor.

- **Parameters**:
  - `code`: The current code in the editor.
  - `position`: The cursor position `{ lineNumber, column }`.
- **Returns**: A string containing the code completion suggestion.

## Templates

The plugin supports registering custom generation templates.

```typescript
interface GenerationTemplate<T = any> {
  name: string;
  description: string;
  schema: z.ZodType<T>;
  prompt: (context: CommandContext, instruction?: string) => string;
}
```

Templates define a schema for the structured output and a prompt function to guide the AI.

## Opcodes

The plugin exposes several opcodes to the scripting environment for direct AI access.

### `ai.text(model, prompt, [system])`

Generates a text response from an LLM.

- `model`: The model identifier (e.g., "gpt-4o").
- `prompt`: The user prompt.
- `system`: (Optional) The system prompt.
- **Returns**: The generated text string.

### `ai.json(model, prompt, [schema])`

Generates a structured JSON response.

- `model`: The model identifier.
- `prompt`: The user prompt.
- `schema`: (Optional) A JSON schema object to enforce structure.
- **Returns**: The generated JSON object.

### `ai.embedding.text(model, text)`

Generates a vector embedding for the given text.

- `model`: The embedding model identifier.
- `text`: The text to embed.
- **Returns**: An array of numbers representing the embedding.

### `ai.image(model, prompt)`

Generates an image.

- `model`: The image generation model.
- `prompt`: The image description.
- **Returns**: An image object (currently internal format).

### `ai.generate_speech(model, text)`

Generates speech audio from text.

- `model`: The text-to-speech model.
- `text`: The text to speak.
- **Returns**: An audio object (currently internal format).

### `ai.transcribe(model, audio)`

Transcribes audio to text.

- `model`: The transcription model.
- `audio`: The audio object to transcribe.
- **Returns**: The transcribed text string.
